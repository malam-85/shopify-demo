# Shopify → Everstox Order Sync

A Python service that fetches paid, unfulfilled orders from the **Shopify Admin GraphQL API** and forwards them to the **Everstox fulfillment platform**.

---

## What it does

1. **Fetch** — Queries Shopify for orders that are:
   - Financially **paid**
   - Fulfillment status **unshipped** or **partial** (not yet fully fulfilled)
   - Created within the last **N days** (default: 14)
2. **Map** — Transforms each Shopify order into an `EverstoxOrder` DTO, including shipping address, billing address, and order metadata.
3. **Send** — POSTs each mapped order to the Everstox create-order endpoint.
4. **Report** — Generates a timestamped HTML report (`report_YYYY-MM-DDTHH-MM-SS.html`) summarising the run.

The HTTP transport for Everstox is injected via `httpx.Client`, so switching between a mock and the live API requires changing a single line in `main.py`.

---

## Architecture

The project follows **Clean Architecture** with four layers. Dependencies only point inward (infrastructure → application → domain).

```
src/
├── domain/                        # Enterprise business rules — no external dependencies
│   ├── order.py                   # Shopify Order domain model (+ address sub-models)
│   ├── everstox_order.py          # Everstox DTO (EverstoxOrder + all nested models)
│   └── interfaces.py              # Protocol interfaces: IOrderService, IEverstoxService, IReportService
│
├── application/                   # Application business rules — orchestration & mapping
│   ├── order_service.py           # Thin service wrapping the order repository
│   ├── everstox_service.py        # Sends EverstoxOrder via injected httpx.Client
│   ├── order_mapper.py            # Maps Shopify Order → EverstoxOrder DTO
│   └── html_report.py             # HtmlReportService — builds & writes the HTML run report
│
├── infrastructure/                # Frameworks & drivers — external I/O
│   ├── shopify_client.py          # httpx wrapper for the Shopify Admin GraphQL API
│   └── order_repository.py        # GraphQL query + pagination + node → domain mapping
│
├── shared/                        # Cross-cutting utilities
│   └── decorators.py              # @log_errors — catches, logs, and re-raises exceptions
│
└── entrypoints/                   # Application entry points
    ├── main.py                    # Aggregation root — wires all layers and runs the pipeline
    ├── executor.py                # Orchestrates fetch → send → report pipeline
    └── settings.py                # Pydantic-Settings config loaded from .env

tests/
└── test_orders.py                 # pytest tests for OrderRepository (mocked GraphQL client)
```

---

## Prerequisites

- Python 3.13
- [uv](https://github.com/astral-sh/uv) (package manager)

```bash
curl -LsSf https://astral.sh/uv/install.sh | sh
```

---

## Setup

**1. Install dependencies**

```bash
make install
```

**2. Configure environment variables**

Copy the example file and fill in your credentials:

```bash
cp .env.example .env
```

Required variables in `.env`:

```dotenv
# Shopify
SHOPIFY_SHOP_NAME=your-store          # e.g. "my-shop" (without .myshopify.com)
SHOPIFY_ACCESS_TOKEN=shpat_xxxx       # Admin API access token
SHOPIFY_API_VERSION=2025-01           # API version (default: 2025-01)

# Everstox
EVERSTOX_BASE_URL=https://api.everstox.com
EVERSTOX_API_KEY=your-everstox-api-key
```

> **Shopify access token:** Go to your Shopify Admin → *Settings* → *Apps and sales channels* → *Develop apps* → create an app with `read_orders` scope.

---

## Running the service

```bash
make run
```

This fetches orders from the last 14 days and forwards them to Everstox. The number of days can be adjusted via the `FETCH_DAYS` constant in `src/entrypoints/main.py`.

### HTML run report

After every run an HTML file is written to the working directory:

```
report_2025-06-15T14-30-00.html
```

The report contains:

| Section | Content |
|---|---|
| **Summary cards** | Number of orders loaded / number sent to Everstox |
| **Loaded Orders** | Table with order number, financial status, fulfillment status, total, and creation date |
| **Everstox Payloads** | One collapsible block per order — click to expand and inspect the full JSON payload that was sent |

The report is generated by `HtmlReportService` ([src/application/html_report.py](src/application/html_report.py)) which is injected into the `Executor` via the `IReportService` interface. A custom implementation (e.g. uploading to S3 or sending via e-mail) can be swapped in without touching the executor.

---

### Switching from mock to live Everstox

By default the Everstox HTTP call is intercepted by a mock transport that only logs the payload. To send real requests, replace the transport in `src/entrypoints/main.py`:

```python
# Mock (default)
http_client = httpx.Client(transport=httpx.MockTransport(_mock_everstox_handler))

# Live
http_client = httpx.Client()
```

---

## Development commands

| Command | Description |
|---|---|
| `make install` | Install all dependencies via `uv sync` |
| `make format` | Auto-format code with `ruff format` |
| `make lint` | Lint and auto-fix with `ruff check --fix` |
| `make check` | Format + lint combined |
| `make mypy` | Static type checking with `mypy` |
| `make test` | Run the test suite with `pytest` |
| `make ci` | Full CI pipeline: `check` + `mypy` + `test` |
| `make run` | Run the service |
| `make clean` | Remove `__pycache__`, `.mypy_cache`, `.ruff_cache` |

---

## Tech stack

| Library | Purpose |
|---|---|
| `httpx` | HTTP client for Shopify GraphQL and Everstox REST requests |
| `pydantic` | Domain models and DTO validation |
| `pydantic-settings` | Type-safe configuration from environment variables |
| `python-dotenv` | Loads `.env` file |
| `loguru` | Structured logging |
| `pytest` | Test framework |
| `mypy` | Static type checking |
| `ruff` | Linting and formatting |
